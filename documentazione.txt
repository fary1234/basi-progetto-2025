# Documentazione per il progetto "fotogram" 
* Studente: Fabrizio Canepa 
* Matricola: 03280A 



## Progettazione concettuale 
Considerare il diagramma ER caricato in upload


### Scelte progettuali

- Modellazione di LIKE e SEGNALAZIONE come entità
  per rappresentare tali operazioni come risorse autonome del sistema.

- Adozione di chiavi composte (id_utente, id_post)
  per LIKE e SEGNALAZIONE
  per riflettere il vincolo di unicità logico del dominio.

- Esclusione del concetto di sessione dal modello
  in quanto gestito a livello applicativo tramite JWT.

- Utilizzo di ID numerici (id_utente): Per l'entità UTENTE, 
  si è scelto di utilizzare un identificatore artificiale numerico (id_utente) come 
  chiave primaria, preferendolo a identificatori naturali come username o email.

  Semplicità di gestione: L'uso di un intero semplifica notevolmente le operazioni di JOIN
   tra le tabelle e la gestione delle chiavi esterne (FK) in tutte le entità collegate 
   (POST, SEGUE, LIKE, SEGNALAZIONE).

  Efficienza di memoria: Un valore numerico occupa meno spazio su disco e
   in memoria rispetto a stringhe di caratteri variabili (come email o username),
   rendendo le operazioni di indicizzazione e ricerca molto più rapide.

  Stabilità: Gli identificatori naturali (come l'email) possono cambiare
   nel tempo; l'ID numerico rimane immutabile, garantendo l'integrità referenziale del database
   a lungo termine.


### Vincoli aggiuntivi

- Un post può contenere esclusivamente un messaggio testuale
   oppure un’immagine, ma non entrambi.

- Se tipo_post = 'TESTO', contenuto deve essere valorizzato
   e immagine deve essere NULL.

- Se tipo_post = 'FOTO', immagine deve essere valorizzata
   e contenuto deve essere NULL.

- Un utente non può seguire sé stesso.

- Un utente può mettere al massimo un like per ciascun post.


### Regole di derivazione / flusso

- Il numero di like di un post è derivato
  dal conteggio delle istanze di LIKE associate al post.

- La bacheca di un utente mostra i post pubblicati
  dall’utente stesso e dagli utenti seguiti,
  ordinati per data di creazione decrescente.

- La visualizzazione dei post è paginata
  e mostra un numero limitato di post per volta.

- L’operazione di like è reversibile:
  se un utente ha già messo like a un post,
  l’operazione successiva comporta la rimozione del like.

- Alla creazione di una segnalazione
  vengono memorizzate la data e l’ora di invio.




## Progettazione logica (Ristrutturazione)

Sono descritte le modifiche apportate al progetto
nelle diverse fasi della ristrutturazione
dello schema E-R.



### Ridondanze

- Non viene introdotta la ridondanza del numero di like su POST,
  in quanto tale informazione è derivabile
  dal conteggio delle istanze di LIKE associate al post.
  La ridondanza ridurrebbe il numero di letture,
  ma comporterebbe aggiornamenti aggiuntivi
  a ogni operazione di like o unlike.

- Non viene introdotta una ridondanza
  sul numero di post pubblicati da un utente,
  poiché tale informazione è derivabile
  e non richiesta frequentemente
  nelle operazioni principali del sistema.



### Eliminazione delle gerarchie

- La gerarchia POST–TESTO/FOTO viene eliminata
  accorpando le entità figlie nell’entità POST,
  poiché gli accessi ai dati del post e al suo contenuto
  avvengono sempre contestualmente.

  La generalizzazione è totale ed esclusiva
  e non sono presenti associazioni
  che coinvolgano esclusivamente le entità figlie.

  Viene introdotto l’attributo discriminante tipo_post
  e vengono accorpati gli attributi contenuto e immagine.

- La gerarchia UTENTE–BASE/MODERATORE viene eliminata
  accorpando le entità figlie nell’entità UTENTE,
  poiché gli accessi ai dati dell’utente
  e alle informazioni di moderazione
  avvengono in modo contestuale.

  Vengono introdotti gli attributi data_nomina,
  is_amministratore e tipo_utente
  per mantenere l’informazione precedentemente
  rappresentata dalla gerarchia.



### Scelte degli identificatori principali

- Per UTENTE viene adottata una chiave artificiale id_utente
  per evitare l’uso di chiavi naturali complesse
  e semplificare le associazioni.

- Per POST viene adottata una chiave artificiale id_post
  per consentire un’identificazione univoca dei post
  indipendente dal contenuto e dall’utente creatore.

- Per LIKE e SEGNALAZIONE viene adottata
  una chiave primaria composta (id_utente, id_post),
  poiché un utente può effettuare
  al massimo un like o una segnalazione
  per ciascun post.

- Per SEGUE viene adottata una chiave primaria composta
  (id_follower, id_followed),
  coerente con la natura ricorsiva della relazione
  e con il vincolo di unicità del follow.


PROGETTAZIONE LOGICA (MODELLO RELAZIONALE)

Legenda:
(PK) = chiave primaria
(FK) = chiave esterna
(UNIQUE) = vincolo di unicità
(NULL) = attributo che ammette valore nullo
(NOT NULL) = attributo che non ammette valore nullo


UTENTE(
    id_utente (PK),
    username (UNIQUE, NOT NULL),
    email (UNIQUE, NOT NULL),
    password (NOT NULL),
    immagine_profilo (NULL),
    data_registrazione (NOT NULL),
    data_nascita (NULL),
    nome (NULL),
    cognome (NULL),
    data_nomina (NULL),
    is_amministratore (NULL),
    tipo_utente (NOT NULL)
)


POST(
    id_post (PK),
    id_utente (FK -> UTENTE.id_utente),
    data_creazione (NOT NULL),
    stato_moderazione (NOT NULL),
    tipo_post (NOT NULL),
    testo (NULL),
    immagine (NULL)
)


SEGUE(
    id_follower (PK, FK -> UTENTE.id_utente),
    id_followed (PK, FK -> UTENTE.id_utente),
    data_inizio (NOT NULL),
    data_fine (NULL)
)


LIKE(
    id_utente (PK, FK -> UTENTE.id_utente),
    id_post (PK, FK -> POST.id_post),
    data (NOT NULL)
)


SEGNALAZIONE(
    id_utente (PK, FK -> UTENTE.id_utente),
    id_post (PK, FK -> POST.id_post),
    data (NOT NULL),
    ora (NOT NULL)
)


VINCOLI LOGICI AGGIUNTIVI

- Ogni POST è creato da un solo UTENTE
- Un UTENTE può creare più POST
- Un UTENTE può seguire molti UTENTI ed essere seguito da molti UTENTI
- Un UTENTE non può seguire sé stesso
- Un UTENTE può mettere al massimo un LIKE per ciascun POST
- Un UTENTE può inviare più SEGNALAZIONI
- Un POST può ricevere più LIKE e più SEGNALAZIONI
- Il numero di like di un post è un attributo derivato


## Progettazione API e query corrispondenti 

Utenti inseriti: 
* 1:  Mario Rossi
* 2:  Luigi Bianchi
* 3:  Sara Toscano
* 5:  Nino Frassica
* 6:  Checco Zalone

### Endpoint /register
 
#### POST 
Registrazione utente

Request body:

{
  "username": "string",
  "email": "string",
  "password": "string",
  "nome": "string",
  "cognome": "string"
}

QUERIES:

INSERT INTO UTENTE (
  username, email, password, nome, cognome,
  data_registrazione, tipo_utente, is_amministratore
)
VALUES ($1, $2, $3, $4, $5, CURRENT_DATE, 'BASE', false)
RETURNING id_utente;

Responses:

*200, restituisce id_utente
*400, parametri mancanti o non validi
*500, errore di database o business logic



### Endpoint /login

#### POST 
Autenticazione utente 

Request body:
{
  "username": "string",
  "password": "string"
}

QUERIES:
SELECT id_utente, password, tipo_utente
FROM UTENTE
WHERE username = $1;

Responses:
* 200, restituisce token JWT
* 400, parametri mancanti o non validi
* 401, credenziali errate
* 500, errore di database o business logic



### Endpoint /posts

#### POST
Inserimento nuovo post (testo o immagine)

Headers:
* bearer (string)

Request body:
{
  "tipo_post": "TESTO | FOTO",
  "contenuto": "string",
  "immagine": "string"
}

QUERIES:
INSERT INTO POST (
  id_utente,
  data_creazione,
  stato_moderazione,
  tipo_post,
  contenuto,
  immagine
)
VALUES ($1, CURRENT_TIMESTAMP, 'APPROVATO', $2, $3, $4);
RETURNING id_post;

Responses:
* 200, post inserito
* 400, parametri mancanti o non validi
* 401, Credenziali errate
* 500, errore di database o business logic


### Endpoint /feed

#### GET
Recupero bacheca utente

Headers:
* bearer (string)

Parameters:
* size (int)
* page (int)

QUERIES:

SELECT p.id_post, u.username, u.immagine_profilo, 
       p.tipo_post, p.contenuto, p.immagine, p.data_creazione
FROM POST p
JOIN UTENTE u ON p.id_utente = u.id_utente
WHERE p.id_utente = $1 
   OR EXISTS (
       SELECT 1 FROM SEGUE 
       WHERE id_follower = $1 AND id_followed = p.id_utente
   )
ORDER BY p.data_creazione DESC
LIMIT $2 OFFSET $3;

Responses:
* 200, restituisce lista dei post
* 401, token non valido
* 500, errore di database o businewss logic


### Endpoint /posts/{id}/like

#### POST
Inserimento o rimozione like

Headers:
* bearer (string)

QUERIES:

INSERT INTO LIKES (id_utente, id_post, data)
VALUES ($1, $2, CURRENT_DATE)
ON CONFLICT (id_utente, id_post)
DO NOTHING;

DELETE FROM LIKES
WHERE id_utente = $1
  AND id_post = $2;


Responses:
* 200, like aggiornato
* 401, token non valido
* 404, post non esistente
* 500, errore di database o business logic



### Endpoint /posts/{id}/segnalazione

#### POST
Segnalazione di un post

Headers:
* bearer (string)

QUERIES:
INSERT INTO SEGNALAZIONE (id_utente, id_post, data, ora)
VALUES ($1, $2, CURRENT_DATE, CURRENT_TIME);

Responses:
* 200, segnalazione registrata
* 401, token non valido
* 409, segnalazione già presente
* 500, errore di database o business logic


### Endpoint /segnalazioni

#### GET
Recupero post segnalati (moderatore)

Headers:
* bearer (string)

QUERIES:
SELECT DISTINCT p.id_post,
       u.username AS autore,
       p.tipo_post,
       p.contenuto,
       p.immagine
FROM SEGNALAZIONE s
JOIN POST p ON s.id_post = p.id_post
JOIN UTENTE u ON p.id_utente = u.id_utente;

Responses:
* 200, lista post segnalati
* 401, token non valido
* 403, utente non autorizzato
* 500, errore di database o business logic


### Endpoint /segnalazioni/{id_post}

#### DELETE
Rimozione segnalazione (moderatore)

Headers:
* bearer (string)

QUERIES:
DELETE FROM SEGNALAZIONE
WHERE id_post = $1;

Responses:
* 200, segnalazione rimossa
* 401, token non valido
* 403, utente non autorizzato
* 404, segnalazione non esistente
* 500, errore di database o business logic


### Endpoint /admin/nomina-moderatore

#### PATCH
Nomina utente come moderatore

Headers:
* bearer (string)

Request body:
{
  "id_utente": 1
}

QUERIES:
UPDATE UTENTE
SET tipo_utente = 'MODERATORE',
    data_nomina = CURRENT_DATE
WHERE id_utente = $1;

Responses:
* 200, utente nominato moderatore
* 401, token non valido
* 403, utente non amministratore
* 404, utente non esistente
* 500, errore di database o business logic


### Endpoint /profilo/foto

#### POST
Caricamento immagine profilo

Headers:
* bearer (string)

Parameters:
* immagine (multipart/form-data)

QUERIES:
UPDATE UTENTE
SET immagine_profilo = $1
WHERE id_utente = $2;

Responses:
* 200, immagine caricata
* 400, parametro mancante
* 401, token non valido
* 500, errore di database o business logic